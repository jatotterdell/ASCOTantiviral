---
title: Primary Outcome
subtitle: |
  Death from any cause or requirement of new intensive respiratory 
  support (invasive or non-invasive ventilation) or vasopressor/inotropic 
  support in the 28 days after randomisation.
description: |
  *This document reports on the analysis of the primary outcome for ASCOT.*
author: "James Totterdell"
date: today
execute: 
  echo: false
  message: false
  warning: false
---

```{r}
#| label: pkgs
#| code-summary: Load packages
library(ASCOTr)
library(tidyverse)
library(lubridate)
library(kableExtra)
library(patchwork)
library(cmdstanr)
library(posterior)
library(bayesplot)
library(ggdist)
library(lme4)
library(broom)
library(broom.mixed)
library(bayestestR)

theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank()))

bayesplot_theme_set(theme_set(theme_classic(base_size = 10, base_family = "Palatino") +
  theme(panel.grid = element_blank(),
        strip.background = element_blank())))

color_scheme_set("red")
options(digits = 4)
```

```{r}
#| label: analysis-sets
#| code-summary: Prepare datasets
all_data <- readRDS(file.path(ASCOT_DATA, "all_data.rds"))
all_daily_data <- readRDS(file.path(ASCOT_DATA, "all_daily_data.rds"))
pd <- readRDS(file.path(ASCOT_DATA, "pd.rds"))

# FAS-ITT
fas_itt_dat <- ASCOTr:::make_fas_itt_set(all_data)
fas_itt_nona_dat <- fas_itt_dat |>
  filter(!is.na(PO))

# ACS-ITT
acs_itt_dat <- ASCOTr:::make_acs_itt_set(all_data)
acs_itt_nona_dat <- acs_itt_dat |>
  filter(!is.na(PO))

# AVS-ITT
avs_itt_dat <- ASCOTr:::make_avs_itt_set(all_data)
avs_itt_nona_dat <- avs_itt_dat |>
  filter(!is.na(PO))

# FAS-ITT Best Case/Worst case
fas_itt_bc_dat <- fas_itt_dat |>
  mutate(PO = if_else(is.na(PO), 0, PO))
fas_itt_wc_dat <- fas_itt_dat |>
  mutate(PO = if_else(is.na(PO), 1, PO))

# FAS AU/NZ
fas_itt_aunz_dat <- fas_itt_dat |> filter(Country %in% c("AU", "NZ"))
fas_itt_aunz_nona_dat <- fas_itt_aunz_dat |> 
  filter(!is.na(PO)) |>
  select(-ctry, -ctry_num, -site, -site_num) |>
  ASCOTr:::add_region_site_groups()

# FAS-PP
fas_pp_dat <- fas_itt_dat |>
  left_join(pd, by = "StudyPatientID") |>
  filter(is.na(pd_A) | pd_A == 0, is.na(pd_C) | pd_C == 0)
fas_pp_nona_dat <- fas_pp_dat |>
  filter(!is.na(PO))

# ACS-PP
acs_pp_dat <- acs_itt_dat |>
  left_join(pd, by = "StudyPatientID") |>
  filter(is.na(pd_C) | pd_C == 0)
acs_pp_nona_dat <- acs_pp_dat |>
  filter(!is.na(PO))

# AVS-PP
avs_pp_dat <- avs_itt_dat |>
  left_join(pd, by = "StudyPatientID") |>
  filter(is.na(pd_A) | pd_A == 0)
avs_pp_nona_dat <- avs_pp_dat |>
  filter(!is.na(PO))
```

```{r}
#| label: stan-models
#| code-summary: Load models
logistic_mod <- compile_cmdstanr_mod(
  file.path("binary", "logistic"), dir = "stan")
logistic_site_epoch <- compile_cmdstanr_mod(
  file.path("binary", "logistic_site_epoch"), dir = "stan")
logistic_site <- compile_cmdstanr_mod(
  file.path("binary", "logistic_site"), dir = "stan")
```

# Primary Outcome Definition

The primary outcome is a composite of death, need for new respiratory support, or vasopressor/inotropic support. From the protocol:

> Death from any cause or requirement of new intensive respiratory support (invasive or non-invasive ventilation) or vasopressor/inotropic support in the 28 days after randomisation. This includes any participant who receives non-invasive mechanical ventilation (either CPAP or BIPAP, apart from the below considerations) any time after enrolment even if not transferred to ICU. It does NOT include the use of humidified high-flow nasal prong oxygen.
>
> Participants on pre-existing home BiPAP or CPAP will not be considered to have met the primary outcome unless they have either:
>
> -   required invasive mechanical ventilation (i.e. intubation), or
> -   graduated from CPAP only whilst asleep to BiPAP at any time, or
> -   graduated from BiPAP only whilst asleep to BiPAP for \>12 hours/day, or
> -   died by day 28
>
> There may be cases where a patient has been assessed as requiring intensive respiratory support (invasive or non-invasive ventilation) or vasopressor/inotropic support, but the patient or family declined treatment and the patient was discharged home. If attempts to obtain 28-day data are unsuccessful or not possible, and the investigator had deemed at the time of discharge that the patient would be highly likely to die within 28 days from randomisation, these participants will be deemed to have met the primary outcome.

# Derivation of the Outcome

Derivation of the outcome requires checking of the daily, discharge, and day 28 data extracts. On the daily data, there is a variable `DD_PrimaryEndpointReachedToday` however this was coded incorrectly in the original database and therefore fails to capture some participants. Additionally, given the composite nature of the outcome it is useful to check all components individually as well as the composite outcome. Therefore, this variable is not used in the derivation, but is included as a cross-check.

Below, each component is summarised in aggregate for the FAS-ITT set.

## Day 28 mortality

```{r}
#| label: tbl-po-component-death
#| code-summary: Summarise the death component
#| tbl-cap: 28-day mortality by domain intervention and overall.
mort_table_A <- all_data |>
  filter_fas_itt() |>
  group_by(AAssignment) |>
  summarise(
    `Mortality_Alive at day 28_` = sum(1 - D28_death, na.rm = TRUE),
    `Mortality_Death within 28 days_Total` = sum(D28_death, na.rm = TRUE),
    `Mortality_Death within 28 days_Prior to discharge` = sum(DIS_death & DIS_day <= 28, na.rm = TRUE),
    `Mortality_Death within 28 days_Post-discharge` = sum(D28_death == 1 & DIS_death == 0, na.rm = TRUE),
    `Mortality_Unknown_` = sum(is.na(D28_death))
  ) |>
  gather(key, Frequency, -AAssignment, factor_key = T) |>
  spread(AAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_")
mort_table_A <- 
  bind_rows(
    mort_table_A,
    summarise(
      .data = mort_table_A,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 5)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:6, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 5)])))
  )
mort_table_C <- all_data |>
  filter_fas_itt() |>
  group_by(CAssignment) |>
  summarise(
    `Mortality_Alive at day 28_` = sum(1 - D28_death, na.rm = TRUE),
    `Mortality_Death within 28 days_Total` = sum(D28_death, na.rm = TRUE),
    `Mortality_Death within 28 days_Prior to discharge` = sum(DIS_death & DIS_day <= 28, na.rm = TRUE),
    `Mortality_Death within 28 days_Post-discharge` = sum(D28_death == 1 & DIS_death == 0, na.rm = TRUE),
    `Mortality_Unknown_` = sum(is.na(D28_death))
  ) |>
  gather(key, Frequency, -CAssignment, factor_key = T) |>
  spread(CAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_") |>
  mutate(Overall = C0 + C1 + C2 + C3 + C4)
mort_table_C <- 
  bind_rows(
    mort_table_C,
    summarise(
      .data = mort_table_C,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 5)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:9, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 5)])))
  )
mort_table <- left_join(mort_table_A, mort_table_C, by = c("Measure", "Outcome", "Breakdown"))
kable(
  mort_table %>% select(-1),
  caption = "Composite primary endpoint breakdown - mortality.",
  align = "llrrrrrrrrr") %>%
  kable_styling("striped", font_size = 10) %>%
  collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) |>
  pack_rows("Mortality", 1, nrow(mort_table)) |>
  add_header_above(c(" " = 2, "Antiviral" = 3, "Anticoagulation" = 5, " " = 1)) |>
  row_spec(0, align = "c") |>
  column_spec(3, border_left = TRUE) |>
  column_spec(6, border_left = TRUE) |>
  column_spec(11, border_left = TRUE)
```

## Vasopressor/inotropic requirement

```{r}
#| label: tbl-po-component-vasopressor
#| code-summary: Summarise the vasopressor/inotropes component
#| tbl-cap: 28-day vasopressor/inotrope use by domain intervention and overall.
vaso_table_A <- all_data |>
  filter_fas_itt() |>
  group_by(AAssignment) |>
  summarise(
    `Vasopressor/inotropes_Not required_` = sum(1 - ANY_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Use within 28 days_Total` = sum(ANY_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Use within 28 days_Prior to discharge` = sum(DD_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Use within 28 days_Post-discharge` = sum(D28_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Unknown_` = sum(is.na(ANY_vasop))
  ) |>
  gather(key, Frequency, -AAssignment, factor_key = T) |>
  spread(AAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_")
vaso_table_A <- 
  bind_rows(
    vaso_table_A,
    summarise(
      .data = vaso_table_A,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 5)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:6, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 5)])))
  )
vaso_table_C <- all_data |>
  filter_fas_itt() |>
  group_by(CAssignment) |>
  summarise(
    `Vasopressor/inotropes_Not required_` = sum(1 - ANY_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Use within 28 days_Total` = sum(ANY_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Use within 28 days_Prior to discharge` = sum(DD_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Use within 28 days_Post-discharge` = sum(D28_vasop, na.rm = TRUE),
    `Vasopressor/inotropes_Unknown_` = sum(is.na(ANY_vasop))
  ) |>
  gather(key, Frequency, -CAssignment, factor_key = T) |>
  spread(CAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_") |>
  mutate(Overall = C0 + C1 + C2 + C3 + C4)
vaso_table_C <- 
  bind_rows(
    vaso_table_C,
    summarise(
      .data = vaso_table_C,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 5)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:9, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 5)])))
  )
vaso_table <- left_join(vaso_table_A, vaso_table_C, by = c("Measure", "Outcome", "Breakdown"))
kable(
  vaso_table %>% select(-1),
  align = "llrrrrrrrrr") %>%
  kable_styling("striped", font_size = 10) %>%
  collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) |>
  pack_rows("Vasopressor/inotropes", 1, nrow(mort_table)) |>
  add_header_above(c(" " = 2, "Antiviral" = 3, "Anticoagulation" = 5, " " = 1)) |>
  row_spec(0, align = "c") |>
  column_spec(3, border_left = TRUE) |>
  column_spec(6, border_left = TRUE) |>
  column_spec(11, border_left = TRUE)
```

## New intensive respiratory support

```{r}
#| label: tbl-po-component-respiratory
#| code-summary: Summarise the ventilation component
#| tbl-cap: 28-day new intensive respiratory support by domain intervention and overall.
vent_table_A <- all_data |>
  filter_fas_itt() |>
  group_by(AAssignment) |>
  summarise(
    `Ventilation_Not required_` = sum(1 - ANY_vent, na.rm = TRUE),
    `Ventilation_Use within 28 days_Total` = sum(ANY_vent, na.rm = TRUE),
    `Ventilation_Use within 28 days_Prior to discharge` = sum(ANY_DD_vent, na.rm = TRUE),
    `Ventilation_Use within 28 days_Post-discharge` = sum(ANY_vent & ANY_DD_vent == 0, na.rm = TRUE),
    `Ventilation_Unknown_` = sum(is.na(ANY_vent))
  ) |>
  gather(key, Frequency, -AAssignment, factor_key = T) |>
  spread(AAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_")
vent_table_A <- 
  bind_rows(
    vent_table_A,
    summarise(
      .data = vent_table_A,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 5)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:6, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 5)])))
  )
vent_table_C <- all_data |>
  filter_fas_itt() |>
  group_by(CAssignment) |>
  summarise(
    `Ventilation_Not required_` = sum(1 - ANY_vent, na.rm = TRUE),
    `Ventilation_Use within 28 days_Total` = sum(ANY_vent, na.rm = TRUE),
    `Ventilation_Use within 28 days_Prior to discharge` = sum(ANY_DD_vent, na.rm = TRUE),
    `Ventilation_Use within 28 days_Post-discharge` = sum(ANY_vent & ANY_DD_vent == 0, na.rm = TRUE),
    `Ventilation_Unknown_` = sum(is.na(ANY_vent))
  ) |>
  gather(key, Frequency, -CAssignment, factor_key = T) |>
  spread(CAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_") |>
  mutate(Overall = C0 + C1 + C2 + C3 + C4)
vent_table_C <- 
  bind_rows(
    vent_table_C,
    summarise(
      .data = vent_table_C,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 5)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:9, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 5)])))
  )
vent_table <- left_join(vent_table_A, vent_table_C, by = c("Measure", "Outcome", "Breakdown"))
kable(
  vent_table %>% select(-1),
  align = "llrrrrrrrrr") %>%
  kable_styling("striped", font_size = 10) %>%
  collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) |>
  pack_rows("Ventilation", 1, nrow(mort_table)) |>
  add_header_above(c(" " = 2, "Antiviral" = 3, "Anticoagulation" = 5, " " = 1)) |>
  row_spec(0, align = "c") |>
  column_spec(3, border_left = TRUE) |>
  column_spec(6, border_left = TRUE) |>
  column_spec(11, border_left = TRUE)
```

## Primary Outcome Composite

```{r}
#| label: tbl-po-composite
#| code-summary: Summarise the composite
#| tbl-cap: |
#|   Composite primary endpoint breakdown - overall.
#| tbl-column: page
comp_table_A <- all_data |>
  filter_fas_itt() |>
  group_by(AAssignment) |>
  summarise(
    `Primary Outcome_No_`  = sum(1 - PO, na.rm = TRUE),
    `Primary Outcome_Yes_` = sum(PO, na.rm = TRUE),
    `Primary Outcome_Unknown_Total` = sum(is.na(PO)),
    `Primary Outcome_Unknown_Day 28 status` = sum(is.na(PO) & is.na(D28_death)),
    `Primary Outcome_Unknown_Vasopressor/inotropes` = 
      sum(is.na(PO) & !is.na(D28_death) & is.na(ANY_vasop))
  ) |>
  gather(key, Frequency, -AAssignment, factor_key = T) |>
  spread(AAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_")
comp_table_A <- 
  bind_rows(
    comp_table_A,
    summarise(
      .data = comp_table_A,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 3)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:6, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 3)])))
  )
comp_table_C <- all_data |>
  filter_fas_itt() |>
  group_by(CAssignment) |>
  summarise(
    `Primary Outcome_No_`  = sum(1 - PO, na.rm = TRUE),
    `Primary Outcome_Yes_` = sum(PO, na.rm = TRUE),
    `Primary Outcome_Unknown_Total` = sum(is.na(PO)),
    `Primary Outcome_Unknown_Day 28 status` = sum(is.na(PO) & is.na(D28_death)),
    `Primary Outcome_Unknown_Vasopressor/inotropes` = 
      sum(is.na(PO) & !is.na(D28_death) & is.na(ANY_vasop))
  ) |>
  gather(key, Frequency, -CAssignment, factor_key = T) |>
  spread(CAssignment, Frequency) |>
  separate(key, into = c("Measure", "Outcome", "Breakdown"), sep = "_") |>
  mutate(Overall = C0 + C1 + C2 + C3 + C4)
comp_table_C <- 
  bind_rows(
    comp_table_C,
    summarise(
      .data = comp_table_C,
      across(where(is.numeric), ~ sum(.x[c(1, 2, 3)])),
      "Outcome" = "Total",
      "Breakdown" = ""
    )
  ) |>
  mutate(
    across(4:9, ~ sprintf("%i (%.1f)", .x, 100 * .x / sum(.x[c(1, 2, 3)])))
  )
comp_table <- left_join(comp_table_A, comp_table_C, by = c("Measure", "Outcome", "Breakdown"))
out <- kable(
  comp_table %>% select(-1),
  align = "llrrrrrrrrr") %>%
  kable_styling("striped", font_size = 10, htmltable_class = "table table-striped", full_width = FALSE) %>%
  collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) |>
  pack_rows("Primary outcome", 1, nrow(mort_table)) |>
  add_header_above(c(" " = 2, "Antiviral" = 3, "Anticoagulation" = 5, " " = 1)) |>
  row_spec(0, align = "c") |>
  column_spec(3, border_left = TRUE) |>
  column_spec(6, border_left = TRUE) |>
  column_spec(11, border_left = TRUE)
out
```

```{r}
#| label: tbl-po-composite-all-anticoagulation
#| code-summary: Summarise the all components
#| tbl-cap: |
#|   Composite primary endpoint breakdown for anticoagulation domain.
tabC <- bind_rows(comp_table_C, mort_table_C, vaso_table_C, vent_table_C)
tabC_head <- all_data %>% 
  filter_fas_itt() %>% 
  dplyr::count(CAssignment = factor(CAssignment, labels = c("Not<br>randomised", intervention_labels()$CAssignment[-1]))) %>%
  mutate(label = paste0(CAssignment, "<br>(n = ", n, ")")) %>%
  pull(label) %>%
  c(paste0("Overall<br><br>(n = ", nrow(all_data %>% filter_fas_itt()), ")"))
colnames(tabC)[4:9] <- tabC_head
kable(
  tabC %>% select(-1),
  align = "llrrrrrr",
  escape = F) %>%
  kable_styling(font_size = 10) %>%
  collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) %>%
  group_rows(
    "Primary outcome", 1, nrow(comp_table_A)) %>%
  group_rows(
    "Mortality", nrow(comp_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A)) %>%
  group_rows(
    "Vasopressor/inotropes", nrow(comp_table_A) + nrow(mort_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A)) %>%
  group_rows(
    "Ventilation", nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + nrow(vent_table_A)) %>%
  add_header_above(c(" " = 2, "Anticoagulation" = 5, " " = 1))
```

```{r}
#| label: save-composite-primary-table-anticoagulation
#| code-summary: Save table to outputs
colnames(tabC)[4:9] <- linebreak(tabC_head, align = "c", linebreaker = "<br>")
out <- kable(
  tabC %>% select(-1),
  format = "latex",
  align = "llrrrrrr",
  booktabs = TRUE,
  escape = F) %>%
  kable_styling(font_size = 8, latex_options = "HOLD_position") %>%
  collapse_rows(1, valign = "top", latex_hline = 'none') %>%
  group_rows(
    "Primary outcome", 1, nrow(comp_table_A)) %>%
  group_rows(
    "Mortality", nrow(comp_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A)) %>%
  group_rows(
    "Vasopressor/inotropes", nrow(comp_table_A) + nrow(mort_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A)) %>%
  group_rows(
    "Ventilation", nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + nrow(vent_table_A)) %>%
  add_header_above(c(" " = 2, "Anticoaguation" = 5, " " = 1)) %>%
  landscape()
save_tex_table(out, fn = "outcomes/primary/composite-breakdown-anticoagulation")
```

```{r}
#| label: tbl-po-composite-all-antiviral
#| code-summary: Summarise the all components
#| tbl-cap: |
#|   Composite primary endpoint breakdown for antiviral domain.
tabA <- bind_rows(
  bind_cols(comp_table_A, comp_table_C[, ncol(comp_table_C)]),
  bind_cols(mort_table_A, mort_table_C[, ncol(mort_table_C)]),
  bind_cols(vaso_table_A, vaso_table_C[, ncol(vaso_table_C)]), 
  bind_cols(vent_table_A, vent_table_C[, ncol(vent_table_C)]))
tabA_head <- all_data %>% 
  filter_fas_itt() %>% 
  dplyr::count(AAssignment = factor(AAssignment, labels = intervention_labels()$AAssignment)) %>%
  mutate(label = paste0(AAssignment, "<br>(n = ", n, ")")) %>%
  pull(label) %>%
  c(paste0("Overall<br><br>(n = ", nrow(all_data %>% filter_fas_itt()), ")"))
colnames(tabA)[4:7] <- tabA_head
kable(
  tabA %>% select(-1),
  align = "llrrrrr",
  escape = F) %>%
  kable_styling(font_size = 11) %>%
  collapse_rows(1, valign = "top", latex_hline = 'custom', custom_latex_hline = 1) %>%
  group_rows(
    "Primary outcome", 1, nrow(comp_table_A)) %>%
  group_rows(
    "Mortality", nrow(comp_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A)) %>%
  group_rows(
    "Vasopressor/inotropes", nrow(comp_table_A) + nrow(mort_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A)) %>%
  group_rows(
    "Ventilation", nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + nrow(vent_table_A)) %>%
  add_header_above(c(" " = 2, "Antiviral" = 3, " " = 1))
```

```{r}
#| label: save-composite-primary-table-antiviral
#| code-summary: Save table to outputs
colnames(tabA)[4:7] <- linebreak(tabA_head, align = "c", linebreaker = "<br>")
out <- kable(
  tabA %>% select(-1),
  format = "latex",
  align = "llrrrrr",
  booktabs = TRUE,
  escape = F) %>%
  kable_styling(font_size = 8, latex_options = "HOLD_position") %>%
  collapse_rows(1, valign = "top", latex_hline = 'none') %>%
  group_rows(
    "Primary outcome", 1, nrow(comp_table_A)) %>%
  group_rows(
    "Mortality", nrow(comp_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A)) %>%
  group_rows(
    "Vasopressor/inotropes", nrow(comp_table_A) + nrow(mort_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A)) %>%
  group_rows(
    "Ventilation", nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + 1, nrow(comp_table_A) + nrow(mort_table_A) + nrow(vaso_table_A) + nrow(vent_table_A)) %>%
  add_header_above(c(" " = 2, "Antiviral" = 3, " " = 1))
save_tex_table(out, fn = "outcomes/primary/composite-breakdown-antiviral")
```

## Summarise Primary Outcome

```{r}
make_po_table_A <- function(dat, format = "html") {
  tab <- dat %>%
    mutate(AAssignment = factor(
      AAssignment, 
      levels = paste0("A", 0:2),
      labels = intervention_labels()$AAssignment)
    ) %>%
    group_by(AAssignment) %>%
    summarise(
      Randomised = n(),
      `Outcome missing` = sprintf("%i (%.1f)", sum(is.na(PO)), 100 * mean(is.na(PO))),
      `Outcome observed` = sprintf("%i (%.1f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
      `Met primary outcome` = sprintf("%i (%.1f)", sum(PO, na.rm = TRUE), 100 * mean(PO, na.rm = TRUE)),
    ) %>%
    bind_rows(
      dat  %>%
        group_by(AAssignment = "Overall") %>%
        summarise(
          Randomised = n(),
          `Outcome missing` = sprintf("%i (%.1f)", sum(is.na(PO)), 100 * mean(is.na(PO))),
          `Outcome observed` = sprintf("%i (%.1f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
          `Met primary outcome` = sprintf("%i (%.1f)", sum(PO, na.rm = TRUE), 100 * mean(PO, na.rm = TRUE)),
      )
    ) %>%
    mutate(AAssignment = fct_inorder(AAssignment)) %>%
    gather(key, value, -AAssignment, factor_key = T) %>%
    spread(AAssignment, value)
  colnames(tab)[1] <- "n (\\%)"
  if(format == "latex") {
    colnames(tab) <- linebreak(colnames(tab), align = "c", linebreaker = "<br>")
  }
    kable(tab,
      format = format,
      align = "lrrrrr",
      escape = FALSE,
      booktabs = TRUE
    ) %>%
    kable_styling(
      font_size = 9, 
      latex_options = "HOLD_position")  
}

make_po_table_C <- function(dat, format = "html") {
  tab <- dat %>%
    mutate(CAssignment = factor(
      CAssignment, 
      levels = paste0("C", 0:4),
      labels = intervention_labels()$CAssignment)
    ) %>%
    group_by(CAssignment) %>%
    summarise(
      Randomised = n(),
      `Outcome missing` = sprintf("%i (%.1f)", sum(is.na(PO)), 100 * mean(is.na(PO))),
      `Outcome observed` = sprintf("%i (%.1f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
      `Met primary outcome` = sprintf("%i (%.1f)", sum(PO, na.rm = TRUE), 100 * mean(PO, na.rm = TRUE)),
    ) %>%
    bind_rows(
      dat  %>%
        group_by(CAssignment = "Overall") %>%
        summarise(
          Randomised = n(),
          `Outcome missing` = sprintf("%i (%.1f)", sum(is.na(PO)), 100 * mean(is.na(PO))),
          `Outcome observed` = sprintf("%i (%.1f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
          `Met primary outcome` = sprintf("%i (%.1f)", sum(PO, na.rm = TRUE), 100 * mean(PO, na.rm = TRUE)),
      )
    ) %>%
    mutate(CAssignment = fct_inorder(CAssignment)) %>%
    gather(key, value, -CAssignment, factor_key = T) %>%
    spread(CAssignment, value)
  colnames(tab)[1] <- "n (\\%)"
  if(format == "latex") {
    colnames(tab) <- linebreak(colnames(tab), align = "c", linebreaker = "<br>")
  }
    kable(tab,
      format = format,
      align = "lrrrrrr",
      escape = FALSE,
      booktabs = TRUE
    ) %>%
    kable_styling(
      font_size = 9, 
      latex_options = "HOLD_position")  
}
```

```{r}
#| label: tbl-domainC-po
#| code-summary: Relationship anti-coagulation to outcome
#| tbl-cap: Primary outcome by anti-coagulation intervention.
make_po_table_C(
    all_data %>%
      filter_acs_itt()
)
save_tex_table(make_po_table_C(
      all_data %>%
      filter_acs_itt(),
      "latex"), 
      "outcomes/primary/anticoagulation-summary")
```

```{r}
#| label: tbl-domainA-po
#| code-summary: Relationship anti-viral to outcome
#| tbl-cap: Primary outcome by anti-viral intervention.
make_po_table_A(
    all_data %>%
      filter_avs_itt()
)
save_tex_table(make_po_table_A(
      all_data %>%
      filter_avs_itt(),
      "latex"), 
      "outcomes/primary/antiviral-summary")
```

# Descriptive Analyses

## By Interim Analysis

```{r}
intdatC <- fas_itt_dat |>
  mutate(
    interim = as.character(case_when(
      RandDate < get_interim_dates()$meet_date[1] ~ 1,
      RandDate < get_interim_dates()$meet_date[2] ~ 2,
      RandDate < get_interim_dates()$meet_date[3] ~ 3,
      RandDate < get_interim_dates()$meet_date[4] ~ 4,
      RandDate < get_interim_dates()$meet_date[5] ~ 5,
      TRUE ~ 5
    )),
    CAssignment = factor(
      CAssignment, labels = intervention_labels_short_break()$CAssignment)
  )
intcounts <- intdatC %>% 
  dplyr::count(interim) %>% 
  mutate(label = paste0("Interim ", interim, " (n = ", n, ")"))
trtcountsC <- intdatC %>% dplyr::count(CAssignment)
ovrtabC <- intdatC %>%
  group_by(interim = "Overall", CAssignment) %>%
  summarise(
    Randomised = 
      sprintf("%i", n()),
    Known = 
      sprintf("%i (%.0f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
    `Met primary outcome` = 
      sprintf("%i (%.0f)", sum(PO, na.rm = T), 100 * mean(PO, na.rm = T)),
    `Death` = 
      sprintf("%i (%.0f)", sum(D28_death, na.rm = T), 100 * sum(D28_death, na.rm = T) / sum(!is.na(PO))),
    `Vasopressor/inotropic support` = 
      sprintf("%i (%.0f)", sum(ANY_vasop, na.rm = T), 100 * sum(ANY_vasop, na.rm = T) / sum(!is.na(PO))),
    `Intensive respiratory support` = 
      sprintf("%i (%.0f)", sum(ANY_vent, na.rm = T), 100 * sum(ANY_vent, na.rm = T) / sum(!is.na(PO)))
  ) %>%
  pivot_longer(`Randomised`:`Intensive respiratory support`, names_to = "Outcome") %>%
  pivot_wider(names_from = CAssignment, values_from = value, values_fill = "-")
inttabC <- intdatC %>%
  group_by(interim, CAssignment) %>%
  summarise(
    Randomised = 
      sprintf("%i", n()),
    Known = 
      sprintf("%i (%.0f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
    `Met primary outcome` = 
      sprintf("%i (%.0f)", sum(PO, na.rm = T), 100 * mean(PO, na.rm = T)),
    `Death` = 
      sprintf("%i (%.0f)", sum(D28_death, na.rm = T), 100 * sum(D28_death, na.rm = T) / sum(!is.na(PO))),
    `Vasopressor/inotropic support` = 
      sprintf("%i (%.0f)", sum(ANY_vasop, na.rm = T), 100 * sum(ANY_vasop, na.rm = T) / sum(!is.na(PO))),
    `Intensive respiratory support` = 
      sprintf("%i (%.0f)", sum(ANY_vent, na.rm = T), 100 * sum(ANY_vent, na.rm = T) / sum(!is.na(PO)))
  ) %>%
  pivot_longer(`Randomised`:`Intensive respiratory support`, names_to = "Outcome") %>%
  pivot_wider(names_from = CAssignment, values_from = value, values_fill = "-")
tabC <- bind_rows(ovrtabC, inttabC)
colnames(tabC) <- linebreak(colnames(tabC), align = "c")
savetab <- kable(
  tabC[, -1],
  format = "latex",
  align = "lrrrr",
  booktabs = TRUE
) %>%
  kable_styling(
    font_size = 9,
    latex_options = "HOLD_position"
  ) %>%
  group_rows(paste0("Overall (n = ", sum(intcounts$n), ")"), 1, 6) %>%
  group_rows(intcounts$label[1], 7, 12) %>%
  group_rows(intcounts$label[2], 13, 18) %>%
  group_rows(intcounts$label[3], 19, 24) %>%
  group_rows(intcounts$label[4], 25, 30) %>%
  group_rows(intcounts$label[5], 31, 36)
save_tex_table(savetab, fn = "outcomes/primary/primary-composite-interims-anticoagulation")
kable(
  tabC[, -1],
  format = "html",
  align = "lrrrr",
) %>%
  kable_styling(
    font_size = 9,
    latex_options = "HOLD_position"
  ) %>%
  group_rows(paste0("Overall (n = ", sum(intcounts$n), ")"), 1, 6) %>%
  group_rows(intcounts$label[1], 7, 12) %>%
  group_rows(intcounts$label[2], 13, 18) %>%
  group_rows(intcounts$label[3], 19, 24) %>%
  group_rows(intcounts$label[4], 25, 30) %>%
  group_rows(intcounts$label[5], 31, 36)
```



```{r}
intdatA <- fas_itt_dat |>
  mutate(
    interim = as.character(case_when(
      RandDate < get_interim_dates()$meet_date[1] ~ 1,
      RandDate < get_interim_dates()$meet_date[2] ~ 2,
      RandDate < get_interim_dates()$meet_date[3] ~ 3,
      RandDate < get_interim_dates()$meet_date[4] ~ 4,
      RandDate < get_interim_dates()$meet_date[5] ~ 5,
      TRUE ~ 5
    )),
    AAssignment = factor(
      AAssignment, labels = intervention_labels_short_break()$AAssignment)
  )
intcounts <- intdatA %>% 
  dplyr::count(interim) %>% 
  mutate(label = paste0("Interim ", interim, " (n = ", n, ")"))
trtcountsA <- intdatA %>% dplyr::count(AAssignment)
ovrtabA <- intdatA %>%
  group_by(interim = "Overall", AAssignment) %>%
  summarise(
    Randomised = 
      sprintf("%i", n()),
    Known = 
      sprintf("%i (%.0f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
    `Met primary outcome` = 
      sprintf("%i (%.0f)", sum(PO, na.rm = T), 100 * mean(PO, na.rm = T)),
    `Death` = 
      sprintf("%i (%.0f)", sum(D28_death, na.rm = T), 100 * sum(D28_death, na.rm = T) / sum(!is.na(PO))),
    `Vasopressor/inotropic support` = 
      sprintf("%i (%.0f)", sum(ANY_vasop, na.rm = T), 100 * sum(ANY_vasop, na.rm = T) / sum(!is.na(PO))),
    `Intensive respiratory support` = 
      sprintf("%i (%.0f)", sum(ANY_vent, na.rm = T), 100 * sum(ANY_vent, na.rm = T) / sum(!is.na(PO)))
  ) %>%
  pivot_longer(`Randomised`:`Intensive respiratory support`, names_to = "Outcome") %>%
  pivot_wider(names_from = AAssignment, values_from = value, values_fill = "-")
inttabA <- intdatA %>%
  group_by(interim, AAssignment) %>%
  summarise(
    Randomised = 
      sprintf("%i", n()),
    Known = 
      sprintf("%i (%.0f)", sum(!is.na(PO)), 100 * mean(!is.na(PO))),
    `Met primary outcome` = 
      sprintf("%i (%.0f)", sum(PO, na.rm = T), 100 * mean(PO, na.rm = T)),
    `Death` = 
      sprintf("%i (%.0f)", sum(D28_death, na.rm = T), 100 * sum(D28_death, na.rm = T) / sum(!is.na(PO))),
    `Vasopressor/inotropic support` = 
      sprintf("%i (%.0f)", sum(ANY_vasop, na.rm = T), 100 * sum(ANY_vasop, na.rm = T) / sum(!is.na(PO))),
    `Intensive respiratory support` = 
      sprintf("%i (%.0f)", sum(ANY_vent, na.rm = T), 100 * sum(ANY_vent, na.rm = T) / sum(!is.na(PO)))
  ) %>%
  pivot_longer(`Randomised`:`Intensive respiratory support`, names_to = "Outcome") %>%
  pivot_wider(names_from = AAssignment, values_from = value, values_fill = "-")
tabA <- bind_rows(ovrtabA, inttabA)
colnames(tabA) <- linebreak(colnames(tabA), align = "c")
savetab <- kable(
  tabA[, -1],
  format = "latex",
  align = "lrrrr",
  booktabs = TRUE
) %>%
  kable_styling(
    font_size = 9,
    latex_options = "HOLD_position"
  ) %>%
  group_rows(paste0("Overall (n = ", sum(intcounts$n), ")"), 1, 6) %>%
  group_rows(intcounts$label[1], 7, 12) %>%
  group_rows(intcounts$label[2], 13, 18) %>%
  group_rows(intcounts$label[3], 19, 24) %>%
  group_rows(intcounts$label[4], 25, 30) %>%
  group_rows(intcounts$label[5], 31, 36)
save_tex_table(savetab, fn = "outcomes/primary/primary-composite-interims-antiviral")
kable(
  tabA[, -1],
  format = "html",
  align = "lrrrr",
) %>%
  kable_styling(
    font_size = 9,
    latex_options = "HOLD_position"
  ) %>%
  group_rows(paste0("Overall (n = ", sum(intcounts$n), ")"), 1, 6) %>%
  group_rows(intcounts$label[1], 7, 12) %>%
  group_rows(intcounts$label[2], 13, 18) %>%
  group_rows(intcounts$label[3], 19, 24) %>%
  group_rows(intcounts$label[4], 25, 30) %>%
  group_rows(intcounts$label[5], 31, 36)
```


```{r}
tab <- bind_cols(tabA, tabC[, -(1:2)])
savetab <- kable(
  tab[, -1],
  format = "latex",
  align = "lrrrrrrrr",
  booktabs = TRUE,
    escape = FALSE
) %>%
  kable_styling(
    font_size = 7,
    latex_options = "HOLD_position"
  ) %>%
  group_rows(paste0("Overall (n = ", sum(intcounts$n), ")"), 1, 6) %>%
  group_rows(intcounts$label[1], 7, 12) %>%
  group_rows(intcounts$label[2], 13, 18) %>%
  group_rows(intcounts$label[3], 19, 24) %>%
  group_rows(intcounts$label[4], 25, 30) %>%
  group_rows(intcounts$label[5], 31, 36) %>%
  add_header_above(c(" " = 1, "Domain A" = 3, "Domain C" = 5))
save_tex_table(savetab, fn = "outcomes/primary/primary-composite-interims")
kable(
  tab[, -1],
  format = "html",
  align = "lrrrrrrrr",
  escape = F
) %>%
  kable_styling(
    font_size = 9,
    latex_options = "HOLD_position"
  ) %>%
  group_rows(paste0("Overall (n = ", sum(intcounts$n), ")"), 1, 6) %>%
  group_rows(intcounts$label[1], 7, 12) %>%
  group_rows(intcounts$label[2], 13, 18) %>%
  group_rows(intcounts$label[3], 19, 24) %>%
  group_rows(intcounts$label[4], 25, 30) %>%
  group_rows(intcounts$label[5], 31, 36) %>%
  add_header_above(c(" " = 1, "Domain A" = 3, "Domain C" = 5))
```

## Intervention

The following presents the primary outcome rate by antiviral intervention

```{r}
#| label: fig-antiviral-po
#| code-summary: Relationship antiviral to outcome
#| fig-cap: Primary outcome by assigned antiviral (AVS-ITT).
#| fig-height: 2
tdat <- all_data %>%
  filter_avs_itt() %>%
  count(Antiviral = factor(AAssignment, labels = intervention_labels_short()$AAssignment[-1]), PO) %>%
  group_by(Antiviral) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    n = `1` + `0`,
    p_1 = `1` / (`1` + `0`),
    p_miss = 0 / (`1` + `0`)
  )
p1 <- ggplot(tdat, aes(Antiviral, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Antiviral")
p2 <- ggplot(tdat, aes(Antiviral, p_1)) +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Antiviral")  +
  ylim(0, NA)
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-antiviral.pdf"), p, height = 2, width = 6)
p
```

## Age

The following presents the primary outcome rate by age in years.

```{r}
#| label: fig-age-po
#| code-summary: Relationship age to outcome
#| fig-cap: |
#|   Relationship (logistic regression linear in age) 
#|   between age at entry and the primary outcome.
#| fig-height: 2
agedat <- fas_itt_dat %>%
  dplyr::count(PO, AgeAtEntry) %>% 
  spread(PO, n, fill = 0) %>% 
  mutate(
    n = `0` + `1` + `<NA>`,
    p = `1` / (`1` + `0`))
agemod <- glm(
  cbind(`1`, `0`) ~ AgeAtEntry, 
  data = agedat, 
  family = binomial())
agedat <- agedat %>%
  mutate(
    ypred = predict(agemod, newdata = agedat, type = "response")
  )
p1 <- ggplot(agedat, aes(AgeAtEntry, n)) +
  geom_col(colour = "grey40", fill = "grey40") +
  geom_vline(xintercept = 60, linetype = 2) +
  labs(y = "Number of\nparticipants",
       x = "Age at entry")
p2 <- ggplot(agedat, aes(AgeAtEntry, p)) +
    geom_point() +
    geom_vline(xintercept = 60, linetype = 2) +
    geom_line(aes(y = ypred)) +
    labs(y = "Proportion\nwith outcome", x = "Age at entry")
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-age.pdf"), p, height = 2, width = 6)
p
```

## Sex

```{r}
#| label: fig-sex-po
#| code-summary: Relationship sex to outcome
#| fig-cap: Primary outcome by sex
#| fig-height: 2
tdat <- all_data %>%
  filter_fas_itt() %>%
  count(Sex, PO) %>%
  group_by(Sex) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    n = `1` + `0` + `<NA>`,
    p_1 = `1` / (`1` + `0`),
    p_miss = `<NA>` / (`1` + `0` + `<NA>`)
  )
p1 <- ggplot(tdat, aes(Sex, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Sex")
p2 <- ggplot(tdat, aes(Sex, p_1)) +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Sex")  +
  ylim(0, NA)
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-sex.pdf"), p, height = 2, width = 6)
p
```

## Oxygen requirement

```{r}
#| label: fig-oxygen-po
#| code-summary: Relationship supplemental oxygen to outcome
#| fig-cap: Primary outcome by supplemental oxygen
#| fig-height: 2
tdat <- all_data %>%
  filter_fas_itt() %>%
  count(`Supplemental oxygen` = factor(supp_oxy2, labels = c("Not required", "Required")), PO) %>%
  group_by(`Supplemental oxygen`) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    n = `1` + `0` + `<NA>`,
    p_1 = `1` / (`1` + `0`),
    p_miss = `<NA>` / (`1` + `0` + `<NA>`)
  )
p1 <- ggplot(tdat, aes(`Supplemental oxygen`, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants")
p2 <- ggplot(tdat, aes(`Supplemental oxygen`, p_1)) +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome")  +
  ylim(0, NA)
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-oxygen.pdf"), p, height = 2, width = 6)
p
```


```{r}
#| label: tbl-oxy-po
#| code-summary: Relationship oxygen requirement to outcome
tdat <- all_data %>%
  filter_fas_itt() %>%
  count(
    `Oxygen requirement` = fct_explicit_na(factor(supp_oxy, levels = 0:1, labels = c("No", "Yes"))), 
    PO) %>%
  group_by(`Oxygen requirement`) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    Total = `1` + `0` + `<NA>`,
    No = sprintf("%i (%.0f)", `0`, 100 * `0` / (`1` + `0`)),
    Yes = sprintf("%i (%.0f)", `1`, 100 * `1` / (`1` + `0`)),
    Unknown = sprintf("%i (%.0f)", `<NA>`, 100 * `1` / Total)
  ) |>
  select(-`0`, -`1`, -`<NA>`)
kable(tdat, align = "lrrrr") |>
  kable_styling("striped", font_size = 12)
```


## Country

The following presents the primary outcome rate by country.

```{r}
#| label: fig-country-po
#| code-summary: Relationship country to outcome
#| fig-cap: Primary outcome by country.
#| fig-height: 2
tdat <- all_data %>%
  filter_fas_itt() %>%
  count(Country = factor(PT_CountryName, levels = c("India", "Australia", "Nepal", "New Zealand")), PO) %>%
  group_by(Country) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    n = `1` + `0` + `<NA>`,
    p_1 = `1` / (`1` + `0`),
    p_miss = `<NA>` / (`1` + `0` + `<NA>`)
  )
p1 <- ggplot(tdat, aes(Country, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Country of enrolment")
p2 <- ggplot(tdat, aes(Country, p_1)) +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Country of enrolment")  +
  ylim(0, NA)
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-country.pdf"), p, height = 2, width = 6)
p
```

## Site

The following presents the primary outcome rate by study site.

```{r}
#| label: fig-site-po
#| code-summary: Relationship site to outcome
#| fig-cap: Primary outcome by site within country.
#| fig-height: 4
tdat <- all_data %>%
  filter_fas_itt() %>%
  dplyr::count(
    Country_lab = Country,
    Site_lab = fct_infreq(Location),
    Country = factor(PT_CountryName, levels = c("India", "Australia", "Nepal", "New Zealand")),
    Site = PT_LocationName,
    PO) %>%
  group_by(Country, Site) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    n = `1` + `0` + `<NA>`,
    p_1 = `1` / (`1` + `0`),
    p_miss = `<NA>` / (`1` + `0` + `<NA>`)
  ) %>%
  ungroup()
p1 <- ggplot(tdat, aes(Site_lab, n)) +
  facet_grid( ~ Country, scales = "free_x", space = "free_x") +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.border = element_rect(fill = NA))
p2 <- ggplot(tdat, aes(Site_lab, p_1)) +
  facet_grid( ~ Country, scales = "free_x", space = "free_x") +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Site of enrolment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.border = element_rect(fill = NA))
p <- p1 / p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-country-site.pdf"), p, height = 4, width = 6.25)
p
```

## Calendar Time

```{r}
#| label: fig-cal-po
#| code-summary: Relationship calendar date to outcome
#| fig-cap: |
#|   Relationship between calendar date and the primary outcome.
#| fig-height: 2
caldat <- fas_itt_dat %>%
  dplyr::count(PO, yr = year(RandDate), mth = month(RandDate)) %>% 
  spread(PO, n, fill = 0) %>% 
  mutate(p = `1` / (`1` + `0`),
         n = `1` + `0`)
p1 <- ggplot(caldat, aes(mth, p)) +
  facet_grid( ~ yr, drop = T, scales = "free_x", space = "free") +
    geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Calendar date (month of year)") +
  scale_x_continuous(breaks = 1:12) +
  ylim(0, 0.25)
p2 <- ggplot(caldat, aes(mth, n)) +
  facet_grid( ~ yr, drop = T, scales = "free_x", space = "free") +
    geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Calendar date (month of year)") +
  scale_x_continuous(breaks = 1:12)
p <- p2 | p1
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-calendar-time.pdf"), p, height = 2, width = 6)
p
```

There was interest in investigating a cut-point of calendar time due to changes in the predominant circulating variant.
A proposed cut-point was 2021-12-20.

```{r}
#| label: fig-cal-po-grp-fas-itt
#| code-summary: Relationship calendar date to outcome by cut-point, FAS-ITT
#| fig-cap: |
#|   Relationship between calendar date and the primary outcome by cut-point, FAS-ITT.
#| fig-height: 2
caldat <- fas_itt_dat %>%
  dplyr::count(PO, grp = factor(
    RandDate >= as.Date("2021-12-20"), labels = c("< 2021-12-20", "\u2265 2021-12-20"))) %>% 
  spread(PO, n, fill = 0) %>% 
  mutate(p = `1` / (`1` + `0`),
         n = `1` + `0`)
p1 <- ggplot(caldat, aes(grp, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Randomisation date")
p2 <- ggplot(caldat, aes(grp, p)) +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Randomisation date")  +
  ylim(0, NA)
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-calendar-time-group-fas-itt.pdf"), p, height = 2, width = 6, device = cairo_pdf)
p
```

```{r}
#| label: fig-cal-po-grp-avs-itt
#| code-summary: Relationship calendar date to outcome by cut-point, AVS-ITT
#| fig-cap: |
#|   Relationship between calendar date and the primary outcome by cut-point, AVS-ITT.
#| fig-height: 2
caldat <- avs_itt_dat %>%
  dplyr::count(PO, grp = factor(
    RandDate >= as.Date("2021-12-20"), labels = c("< 2021-12-20", "\u2265 2021-12-20"))) %>% 
  spread(PO, n, fill = 0) %>% 
  mutate(p = `1` / (`1` + `0`),
         n = `1` + `0`)
p1 <- ggplot(caldat, aes(grp, n)) +
  geom_col() +
    labs(
      y = "Number of\nparticipants", 
      x = "Randomisation date")
p2 <- ggplot(caldat, aes(grp, p)) +
  geom_point() +
    labs(
      y = "Proportion meeting\nprimary outcome", 
      x = "Randomisation date")  +
  ylim(0, NA)
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-calendar-time-group-avs-itt.pdf"), p, height = 2, width = 6, device = cairo_pdf)
p
```

## Baseline CRP

```{r}
#| label: tbl-crp-po
#| code-summary: Relationship CRP to outcome
#| tbl-cap: Relationship between CRP and primary outcome, AVS-ITT.
tdat <- avs_itt_dat %>%
  count(
    `Baseline CRP` = crp_tertile, 
    PO) %>%
  group_by(`Baseline CRP`) %>%
  spread(PO, n, fill = 0) %>%
  mutate(
    Total = `1` + `0`,
    No = sprintf("%i (%.0f)", `0`, 100 * `0` / (`1` + `0`)),
    Yes = sprintf("%i (%.0f)", `1`, 100 * `1` / (`1` + `0`)),
    Unknown = sprintf("%i (%.0f)", 0, 100 * `1` / Total)
  ) |>
  select(-`0`, -`1`)
kable(tdat, align = "lrrrr") |>
  kable_styling("striped", font_size = 12)
```


## Days since symptom onset

```{r}
#| label: fig-dsfs-po
#| code-summary: Relationship days since sympton onset to outcome
#| fig-cap: |
#|   Relationship (logistic regression linear) 
#|   between days since symptom onset at entry and the primary outcome.
#| fig-height: 2
dsfsdat <- fas_itt_dat %>%
  dplyr::count(PO, dsfs) %>% 
  spread(PO, n, fill = 0) %>% 
  mutate(n = `1` + `0`,
         p = `1` / (`1` + `0`))
dsfsmod <- glm(
  cbind(`1`, `0`) ~ dsfs, 
  data = dsfsdat, 
  family = binomial())
dsfsdat <- dsfsdat %>%
  mutate(
    ypred = predict(dsfsmod, newdata = dsfsdat, type = "response")
  )
p1 <- ggplot(dsfsdat, aes(dsfs, n)) +
  geom_col(colour = "grey40", fill = "grey40") +
  geom_vline(xintercept = 7.5, linetype = 2) +
  labs(y = "Number of\nparticipants",
       x = "Days since first symptoms")
p2 <- ggplot(dsfsdat, aes(dsfs, p)) +
    geom_point() +
    geom_vline(xintercept = 7.5, linetype = 2) +
    geom_line(aes(y = ypred)) +
    labs(y = "Proportion\nwith outcome", 
         x = "Days since first symptoms")
p <- p1 | p2
path <- file.path("outputs", "figures", "outcomes", "primary")
ggsave(file.path(path, "outcome-dsfs.pdf"), p, height = 2, width = 6)
p
```

# MLE Estimates

As a point of reference, treatment only logistic regression models are estimated using maximum likelihood for each of the 3 analysis sets.
These are obviously inappropriate given the design, but provide some reference values.

## FAS-ITT

```{r}
#| label: tbl-fas-itt-trt-only-mle
#| tbl-cap: Maximum likelihood odds ratio estimates for FAS-ITT set.
fas_itt_mle <- glmer(
  PO ~ facA + facC + inelgc3 + agegte60 + supp_oxy2 + ctry + (1 | epoch),
  data = fas_itt_nona_dat, 
  family = binomial())
tidy(fas_itt_mle, conf.int = TRUE, exponentiate = TRUE) |>
  kable(digits = 2) |>
  kable_styling("striped", font_size = 12)
```

## ACS-ITT

```{r}
#| label: tbl-acs-itt-trt-only-mle
#| tbl-cap: Maximum likelihood odds ratio estimates for ACS-ITT set.
acs_itt_mle <- glmer(
  PO ~ facA + facC + inelgc3 + agegte60 + supp_oxy2 + ctry + (1 | epoch), 
  data = acs_itt_nona_dat, 
  family = binomial())
tidy(acs_itt_mle, conf.int = TRUE, exponentiate = TRUE) |>
  kable(digits = 2) |>
  kable_styling("striped", font_size = 12)
```

## AVS-ITT

```{r}
#| label: tbl-avs-itt-trt-only-mle
#| tbl-cap: Maximum likelihood odds ratio estimates for AVS-ITT set.
avs_itt_mle <- glm(PO ~ facA + supp_oxy2, data = avs_itt_nona_dat, family = binomial())
tidy(avs_itt_mle, conf.int = TRUE, exponentiate = TRUE) |>
  kable(digits = 2) |>
  kable_styling("striped", font_size = 12)
```

# Analyses

The SAP specified the primary analyses as using the AVS-ITT set with terms for:

- all treatments (including ineligibilities and not-randomised terms)
- region
- site
- epoch
- age
- sex
- oxygen requirement
- C-reactive protein.

This was to be repeated for FAS-ITT.

Some general notes:

- there were concerns with the accuracy of C-reactive protein values reported in India (incorrect units reported, unrealistic values), therefore CRP is treated as unknown for Indian participants (most participants). Therefore, CRP is included for models using AVS-ITT but excluded for models using FAS-ITT.
- all interventions in AVS-ITT were concurrently randomised. Therefore, epoch is excluded from the AVS-ITT model.
- due to insufficient data, there are concerns that too many model parameters are included when restricting to AVS-ITT. The model parameters will be largely driven by the pre-specified priors for many of the adjustment variables. Therefore, an antiviral-treatment only model was also investigated
- to assess prior sensitivity analyses are repeated with diffuse and sceptical priors on treatment variances, and assuming treatment coding on the effect terms rather than orthonormal coding.

## FAS-ITT

### Pre-specified prior

```{r}
res <- fit_primary_model(fas_itt_nona_dat, logistic_site_epoch, ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
saveRDS(res, file.path("outputs", "models", "primary", "fas-itt-default.rds"))
```

Using FAS-ITT (excluding participants with missing primary outcome) and the pre-specified primary model (excluding baseline CRP) the conditional odds ratio for Nafamostat versus standard of care was [median (95% CrI), Pr(OR<1)] `r sprintf("%.2f (%.2f, %.2f), %.2f", median(res$drws$AOR), quantile(res$drws$AOR, 0.025), quantile(res$drws$AOR, 0.975), Pr(res$drws$AOR < 1))`.

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-fas-itt-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-fas-itt
#| tbl-cap: Decision quantity summaries, FAS-ITT.
save_tex_table(
  decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR), format = "latex") |> 
    bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR), format = "latex")) |>
    kable("latex", align = "llrrrr", booktabs = TRUE, escape = FALSE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    pack_rows("Antiviral", 1, 2) |>
    pack_rows("Anticoagulation", 3, 6),
  "outcomes/primary/primary-model-fas-itt-decision-table")

decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 10) |>
  pack_rows("Antiviral", 1, 2) |>
  pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-fas-itt-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

:::{.callout-caution collapse="true"}
#### Diagnostics
```{r}
res$fit$summary(c("beta", "gamma_epoch", "tau_epoch", "gamma_site", "tau_site"))
res$fit$diagnostic_summary()
```
:::

:::{.callout-caution collapse="true"}
#### Trace plots
```{r}
mcmc_trace(res$drws["beta"])
mcmc_trace(res$drws["gamma_epoch"])
mcmc_trace(res$drws["tau_epoch"])
mcmc_trace(res$drws["gamma_site"])
mcmc_trace(res$drws["tau_site"])
```
:::


#### Posterior Predictive Checks

```{r}
#| label: primary-fas-itt-ppc
y_ppc <- res$drws$y_ppc
ppc_dat <- bind_cols(fas_itt_nona_dat, tibble(y_ppc = y_ppc))

grp_ppc <- function(grp) {
  ppc_dat %>%
    group_by(grp = !!grp) %>%
    summarise(
      mean_y = mean(PO),
      rvar_mean_y_ppc = rvar_mean(y_ppc)
    )
}

grp2_ppc <- function(grp1, grp2) {
  ppc_dat %>%
    group_by(grp1 = !!grp1, grp2 = !!grp2) %>%
    summarise(
      mean_y = mean(PO),
      rvar_mean_y_ppc = rvar_mean(y_ppc)
    )
}

plot_grp_ppc <- function(dat, lab = "") {
  dat %>%
    ggplot(aes(y = grp, xdist = rvar_mean_y_ppc)) +
    stat_interval(size = 2) +
    geom_point(aes(x = mean_y, y = 1:nrow(dat)), colour = "red", shape = 23) +
    labs(
      x = "Posterior predictive\nproportion", 
      y = lab)  
}

ppc_A <- grp_ppc(sym("AAssignment"))
ppc_C <- grp_ppc(sym("CAssignment"))
ppc_ctry <- grp_ppc(sym("Country"))
ppc_epoch <- grp_ppc(sym("epoch"))
ppc_site <- ppc_dat %>%
  group_by(Country = Country, grp = site) %>%
  summarise(
    mean_y = mean(PO),
    rvar_mean_y_ppc = rvar_mean(y_ppc)
  )

p0 <- plot_grp_ppc(ppc_A, "Anti-\nviral") + labs(x = "")
p1 <- plot_grp_ppc(ppc_C, "Anti-\ncoagulation") + labs(x = "")
p2 <- plot_grp_ppc(ppc_ctry, "Country") + labs(x = "")
p3 <- plot_grp_ppc(ppc_epoch, "Epoch") + labs(x = "")
p4 <- plot_grp_ppc(ppc_site %>% filter(Country == "IN"), "Sites\nIndia")  + labs(x = "")
p5 <- plot_grp_ppc(ppc_site %>% filter(Country == "AU"), "Sites\nAustralia") + labs(x = "")
p6 <- plot_grp_ppc(ppc_site %>% filter(Country == "NP"), "Sites\nNepal")
p7 <- plot_grp_ppc(ppc_site %>% filter(Country == "NZ"), "Sites\nNZ")
p <- ((p3 | (p0 | p1) / p2) / 
        ( (p4 | p5) / (p6 | p7) + 
            plot_layout(heights = c(3, 1)) ) ) +
  plot_layout(heights = c(1, 1.5), guides = "collect") &
  theme(legend.position = "bottom")
pth <- file.path("outputs", "figures", "outcomes", "primary",
                 "primary-model-fas-itt-ppc.pdf")
ggsave(pth, p, width = 6, height = 5.5)
p
```

### Treatment only

In this model, we investigate Nafamostat as the only fixed covariate, but still include site (not nested within region) and epoch as random effects.

```{r}
res <- fit_primary_model(
  fas_itt_nona_dat, 
  logistic_site_epoch, 
  ctr = contr.equalprior,
  vars = NULL,
  beta_sd_var = NULL,
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-trt-only
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR))
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-trt-only-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
p
```

### Treatment coding prior

The primary model is re-fit assuming a prior specified on the treatment indicator variables rather than on the orthonormal terms. Note that the prior scales need to be adjusted. The prior $\text{Normal}(0,1)$ on the orthonormal terms imply $\text{Normal}(0,2)$ on the pair-wise differences. Therefore, for the treatment coding we specify a prior standard deviation of $\sqrt{2}$ instead of 1.

```{r}
res <- fit_primary_model(fas_itt_nona_dat, logistic_site_epoch, ctr = contr.treatment, beta_sd_trt = sqrt(2))
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-trt
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-epoch-site-terms-trt
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
p
```

### Diffuse prior

For all fixed model parameters (including treatment differences), assume $\text{Normal}(0, 10^2)$.

```{r}
res <- fit_primary_model(
  fas_itt_nona_dat, 
  logistic_site_epoch, 
  ctr = contr.equalprior_deviations, 
  beta_sd_int = 10, beta_sd_trt = 10, beta_sd_var = rep(10, 6)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-diffuse
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-epoch-site-terms-diffuse
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
p
```

### Sceptical prior

For treatment differences, assume $\text{Normal}(0, 0.4^2)$

```{r}
res <- fit_primary_model(
  fas_itt_nona_dat, 
  logistic_site_epoch, 
  ctr = contr.equalprior_pairs, 
  beta_sd_trt = 0.4
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-sceptical
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-epoch-site-terms-sceptical
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
p
```

### Best Case

```{r}
res <- fit_primary_model(fas_itt_bc_dat, logistic_site_epoch, ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-best-case
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-fas-itt-best-case-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: fig-or-densities-fas-itt-best-case-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-best-case-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-best-case-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-best-case-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

### Worst Case

```{r}
res <- fit_primary_model(fas_itt_wc_dat, logistic_site_epoch, ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-worst-case
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-fas-itt-worst-case-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: fig-or-densities-fas-itt-worst-case-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-worst-case-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-worst-case-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-worst-case-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

### Australia/New Zealand Only

- dropped region covariate
- dropped ineligibility for aspirin covariate (4 cases)

```{r}
res <- fit_primary_model(
  fas_itt_aunz_nona_dat, 
  logistic_site_epoch, 
  vars = c("agegte60", "sexF", "supp_oxy2"),
  beta_sd_var = c(2.5, 2.5, 2.5),
  ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Age \u2265 60", "Female", "Oxygen requirement")
```


```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-aunz
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-fas-itt-aunz-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: fig-or-densities-fas-itt-aunz-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-aunz-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-aunz-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("Australia\nNew Zealand"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-itt-aunz-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

### Country instead of region

```{r}
res <- fit_primary_model(
  fas_itt_nona_dat, 
  logistic_site_epoch, 
  vars = c("inelgc3", "agegte60", "sexF", "supp_oxy2", "ctry2"),
  beta_sd_var = c(10, 2.5, 2.5, 2.5, 1, 1, 1),
  ctry_var = "ctry2_num",
  site_var = "site2_num",
  ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia", "Nepal", "New Zealand")
```


```{r}
#| label: odds-ratio-summary-table-primary-model-fas-itt-country3
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-fas-itt-country2
#| tbl-cap: Decision quantity summaries, FAS-ITT.
decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 10) |>
  pack_rows("Antiviral", 1, 2) |>
  pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-fas-itt-model-country2
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
p
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-itt-epoch-site-terms-country2
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia", "Nepal", "New Zealand"))
)
p
```

## ACS-ITT

### Pre-specified

```{r}
res <- fit_primary_model(acs_itt_nona_dat, logistic_site_epoch, ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-acs-itt
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-acs-itt-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-acs-itt
#| tbl-cap: Decision quantity summaries, ACS-ITT.
save_tex_table(
  decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR), format = "latex") |> 
    bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR), format = "latex")) |>
    kable("latex", align = "llrrrr", booktabs = TRUE, escape = FALSE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    pack_rows("Antiviral", 1, 2) |>
    pack_rows("Anticoagulation", 3, 6),
  "outcomes/primary/primary-model-acs-itt-decision-table")

decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 12) |>
  pack_rows("Antiviral", 1, 2) |>
  pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-acs-itt-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-acs-itt-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-acs-itt-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-acs-itt-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

### Treatment coding prior

```{r}
res <- fit_primary_model(
  acs_itt_nona_dat, 
  logistic_site_epoch, 
  ctr = contr.treatment, 
  beta_sd_trt = sqrt(2)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-acs-itt-trt
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: odds-ratio-summary-primary-model-acs-itt-epoch-site-terms-trt
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
p
```

### Diffuse

```{r}
res <- fit_primary_model(
  fas_itt_nona_dat, 
  logistic_site_epoch, 
  ctr = contr.equalprior_deviations, 
  beta_sd_int = 10, beta_sd_trt = 10, beta_sd_var = rep(10, 6)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-acs-itt-diffuse
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: odds-ratio-summary-primary-model-acs-itt-epoch-site-terms-diffuse
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
p
```

## AVS-ITT

### Treatment Only

The SAP suggests that the primary analysis be based on the AVS-ITT set, but that adjustment should still be made for all the covariates.
This is somewhat problematic as there is no longer sufficient data to inform all of the covariates (e.g. little information available on the effect of anticoagulation interventions, country, age etc.).
The following analysis is restricted to the AVS-ITT set but restricts the analysis to a reduced set:

- antiviral intervention
- anticoagulation intervention
- age group
- oxygen requirement

```{r}
res <- fit_primary_model(
  avs_itt_nona_dat,
  logistic_mod,
  vars = NULL,
  beta_sd_var = NULL,
  includeC = FALSE
)
names(res$drws$AOR) <- "Nafamostat"
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-itt-trt-only
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR), "latex"),
  "outcomes/primary/primary-model-avs-itt-summary-table-trt-only")
odds_ratio_summary_table(res$drws$AOR)
```

```{r}
#| label: fig-or-densities-avs-itt-model-trt-only
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-avs-itt-odds-ratio-densities-trt-only.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

### Pre-specified - without site

In this section the pre-specified model with covariates is fit.
However, again with no region, epoch or site specific terms.

```{r}
res <- fit_primary_model(
  avs_itt_nona_dat,
  logistic_mod,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile"),
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-itt
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-avs-itt-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-avs-itt
#| tbl-cap: Decision quantity summaries, AVS-ITT.
save_tex_table(
  decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR), format = "latex") |> 
    # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR), format = "latex")) |>
    kable("latex", align = "llrrrr", booktabs = TRUE, escape = FALSE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    pack_rows("Antiviral", 1, 2),
    # pack_rows("Anticoagulation", 3, 6),
  "outcomes/primary/primary-model-avs-itt-decision-table")

decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 12) |>
  pack_rows("Antiviral", 1, 2)
  # pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-avs-itt-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-avs-itt-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```


### Pre-specified - with site

In this section the pre-specified model with covariates is fit.
Again with no epoch terms, but we do include region and site.

```{r}
res <- fit_primary_model(
  avs_itt_nona_dat |> mutate(ctry = droplevels(ctry)),
  logistic_site,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile", "ctry"),
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 1)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-itt-with-site
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-avs-itt-with-site-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-avs-itt-wth-site
#| tbl-cap: Decision quantity summaries, AVS-ITT.
save_tex_table(
  decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR), format = "latex") |> 
    # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR), format = "latex")) |>
    kable("latex", align = "llrrrr", booktabs = TRUE, escape = FALSE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    pack_rows("Antiviral", 1, 2),
    # pack_rows("Anticoagulation", 3, 6),
  "outcomes/primary/primary-model-avs-itt-with-site-decision-table")

decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 12) |>
  pack_rows("Antiviral", 1, 2)
  # pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-avs-itt-model-wth-site
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-avs-itt-with-site-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-avs-itt-epoch-site-terms-with-site
p <- plot_site_terms(
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-avs-itt-epoch-site-terms-with-site.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

### Treatment coding

```{r}
res <- fit_primary_model(
  avs_itt_nona_dat,
  logistic_mod,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile"),
  ctr = contr.treatment,
  beta_sd_trt = sqrt(2),
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5),
  includeC = TRUE
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-itt-trt
#| tbl-cap: Posterior summaries for model parameters, AVS-ITT, prior on treatment coding.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$OR[-1]))
```

### Diffuse prior

```{r}
res <- fit_primary_model(
  avs_itt_nona_dat,
  logistic_mod,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile"),
  beta_sd_int = 10,
  beta_sd_trt = 10,
  beta_sd_var = c(10, 10, 10, 10, 10, 10),
  includeC = FALSE
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-itt-diffuse
#| tbl-cap: Posterior summaries for model parameters, AVS-ITT.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$OR[-1]))
```


### Sceptical prior

```{r}
res <- fit_primary_model(
  avs_itt_nona_dat,
  logistic_mod,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile"),
  beta_sd_int = 2.5,
  beta_sd_trt = 0.4,
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5),
  includeC = FALSE
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-itt-sceptical
#| tbl-cap: Posterior summaries for model parameters, AVS-ITT.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$OR[-1]))
```

## FAS-PP

Here the primary model is fit to the FAS-PP where per-protocol participants were identified as per the provided listings. Participants may be excluded due to failing the per-protocol criteria for the anticoagulation domain or the antiviral domain (or both).

```{r}
#| label: tbl-domainC-po-fas-pp
#| code-summary: Relationship anti-coagulation to outcome
#| tbl-cap: Primary outcome by anti-coagulation intervention.
make_po_table_C(fas_pp_dat)
save_tex_table(
  make_po_table_C(
      fas_pp_dat,
      "latex"), 
  "outcomes/primary/anticoagulation-summary-fas-pp")
```

```{r}
#| label: tbl-domainA-po-fas-pp
#| code-summary: Relationship anti-viral to outcome
#| tbl-cap: Primary outcome by anti-viral intervention.
make_po_table_A(fas_pp_dat)
save_tex_table(
  make_po_table_A(
    fas_pp_dat,
    "latex"), 
  "outcomes/primary/antiviral-summary-fas-pp")
```

```{r}
res <- fit_primary_model(fas_pp_nona_dat, logistic_site_epoch, ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-fas-pp
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-fas-pp-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: fig-or-densities-fas-pp-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-pp-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-fas-pp-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-fas-pp-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

## ACS-PP

Note that for ACS-PP only participants who were not per-protocol according to the anticoagulation domain are excluded. A participant who was not per-protocol according to the antiviral domain but was per-protocol according to the anticoagulation domain is kept in the analysis set. The alternative would be to exclude both (as for FAS-PP).

```{r}
res <- fit_primary_model(acs_pp_nona_dat, logistic_site_epoch, ctr = contr.equalprior)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c("Ineligible aspirin", "Age \u2265 60", "Female", "Oxygen requirement", "Australia/New Zealand", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-acs-pp
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-acs-pp-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: fig-or-densities-acs-pp-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-acs-pp-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

```{r}
#| label: odds-ratio-summary-primary-model-acs-pp-epoch-site-terms
p <- plot_epoch_site_terms(
  res$drws$gamma_epoch, 
  res$drws$gamma_site,
  factor(
    res$dat$region_by_site, 
    labels = c("India", "Australia\nNew Zealand", "Nepal"))
)
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-acs-pp-epoch-site-terms.pdf")
ggsave(pth, p, width = 6, height = 4.5)
p
```

## AVS-PP

Note that for AVS-PP only participants who were not per-protocol according to the antiviral domain are excluded. A participant was not per-protocol according to the anticoagulation domain but was per-protocol according to the antiviral domain is kept in the analysis set. The alternative would be to exclude both (as for FAS-PP).

```{r}
#| label: tbl-domainC-po-avs-pp
#| code-summary: Relationship anti-coagulation to outcome
#| tbl-cap: Primary outcome by anti-coagulation intervention, AVS-PP.
make_po_table_C(avs_pp_dat)
save_tex_table(
  make_po_table_C(
      avs_pp_dat,
      "latex"), 
  "outcomes/primary/anticoagulation-summary-avs-pp")
```

```{r}
#| label: tbl-domainA-po-avs-pp
#| code-summary: Relationship anti-viral to outcome
#| tbl-cap: Primary outcome by anti-viral intervention.
make_po_table_A(avs_pp_dat)
save_tex_table(
  make_po_table_A(
    avs_pp_dat,
    "latex"), 
  "outcomes/primary/antiviral-summary-avs-pp")
```

### Pre-specified

In this section the pre-specified model with covariates is fit.
However, again with no region, epoch or site specific terms.

```{r}
res <- fit_primary_model(
  avs_pp_nona_dat |> mutate(ctry = droplevels(ctry)),
  logistic_site,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile", "ctry"),
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 1)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-pp
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]), "latex"),
  "outcomes/primary/primary-model-avs-pp-summary-table")
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-avs-pp
#| tbl-cap: Decision quantity summaries, AVS-PP.
save_tex_table(
  decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR), format = "latex") |> 
    # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR), format = "latex")) |>
    kable("latex", align = "llrrrr", booktabs = TRUE, escape = FALSE) |>
    kable_styling(latex_options = "HOLD_position", font_size = 8) |>
    pack_rows("Antiviral", 1, 2),
    # pack_rows("Anticoagulation", 3, 6),
  "outcomes/primary/primary-model-avs-pp-decision-table")

decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 12) |>
  pack_rows("Antiviral", 1, 2)
  # pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-avs-pp-model
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-avs-pp-odds-ratio-densities.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

### Treatment Only

```{r}
res <- fit_primary_model(
  avs_pp_nona_dat,
  logistic_mod,
  vars = NULL,
  beta_sd_var = NULL,
  includeC = FALSE
)
names(res$drws$AOR) <- "Nafamostat"
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-pp-trt-only
#| tbl-cap: Posterior summaries for model parameters.
save_tex_table(
  odds_ratio_summary_table(c(res$drws$AOR), "latex"),
  "outcomes/primary/primary-model-avs-pp-summary-table-trt-only")
odds_ratio_summary_table(res$drws$AOR)
```

```{r}
#| label: fig-or-densities-avs-pp-model-trt-only
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR, res$drws$COR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
pth <- file.path("outputs", "figures", "outcomes", "primary", "primary-model-avs-pp-odds-ratio-densities-trt-only.pdf")
ggsave(pth, p, width = 6, height = 2.5)
p
```

### Treatment coding

```{r}
res <- fit_primary_model(
  avs_pp_nona_dat |> mutate(ctry = droplevels(ctry)),
  logistic_site,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile", "ctry"),
  ctr = contr.treatment,
  beta_sd_trt = sqrt(2),
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 1)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-pp-trt-ctr
#| tbl-cap: Posterior summaries for model parameters, AVS-PP, prior on treatment coding.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

### Sceptical

```{r}
res <- fit_primary_model(
  avs_pp_nona_dat |> mutate(ctry = droplevels(ctry)),
  logistic_site,
  vars = c("agegte60", "sexF", "supp_oxy2", "crp_tertile", "ctry"),
  beta_sd_trt = 0.4,
  beta_sd_var = c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5, 1)
)
names(res$drws$AOR) <- "Nafamostat"
names(res$drws$COR) <- intervention_labels2()$CAssignment[-(1:2)]
names(res$drws$OR)[-1] <- c(
  "Age \u2265 60", "Female", "Required oxygen", "CRP (2nd tertile)", "CRP (3rd tertile)", "CRP (unknown)", "Nepal")
```

```{r}
#| label: odds-ratio-summary-table-primary-model-avs-pp-sceptical
#| tbl-cap: Posterior summaries for model parameters.
odds_ratio_summary_table(c(res$drws$AOR, res$drws$COR, res$drws$OR[-1]))
```

```{r}
#| label: tbl-decision-quantities-avs-pp-sceptical
#| tbl-cap: Decision quantity summaries, AVS-PP.
decision_quantity_summary_table(c("SoC" = rvar(1), res$drws$AOR)) |> 
  # bind_rows(decision_quantity_summary_table(c("Low-dose" = rvar(1), res$drws$COR))) |>
  kable(align = "llrrrr") |>
  kable_styling("striped", font_size = 12) |>
  pack_rows("Antiviral", 1, 2)
  # pack_rows("Anticoagulation", 3, 6)
```

```{r}
#| label: fig-or-densities-avs-pp-model-sceptical
#| fig-cap: Posterior densities for odds ratio contrasts.
p <- plot_or_densities(c(res$drws$AOR)) +
  labs(x = "Odds ratio (log scale)", y = "Comparison")
p
```
